name: Scrape Telegram IPAs

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install telethon

      - name: Run scraper
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_SESSION_STRING: ${{ secrets.TELEGRAM_SESSION_STRING }}
          TELEGRAM_CHANNELS: ${{ vars.TELEGRAM_CHANNELS || 'blatants,binnichtaktivipas,ftrepo_xyz' }}
          REPO_BASE_URL: ${{ vars.REPO_BASE_URL || 'https://example.com' }}
          MAX_DOWNLOADS_PER_CHANNEL: ${{ vars.MAX_DOWNLOADS_PER_CHANNEL || '5' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ vars.OPENROUTER_MODEL || 'openai/gpt-4o-mini' }}
          PYTHONUNBUFFERED: 1
        run: |
          python -u scraper.py

      - name: Commit and push scraper changes
        run: |
          git config --local user.email "github-actions@github.local"
          git config --local user.name "GitHub Actions"
          git add apps.json
          git diff --staged --quiet || git commit -m "Update apps.json [skip ci]"
          git push

      - name: Clean duplicate apps
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          OPENROUTER_MODEL: ${{ vars.OPENROUTER_MODEL || 'openai/gpt-4o-mini' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PYTHONUNBUFFERED: 1
        run: |
          echo "Starting duplicate cleanup process..."
          python -u clean_duplicates.py

      - name: Commit and push cleanup changes
        run: |
          git config --local user.email "github-actions@github.local"
          git config --local user.name "GitHub Actions"
          git add apps.json tweaks_list.json
          git diff --staged --quiet || git commit -m "Clean duplicate apps [skip ci]"
          git push

      - name: Convert to AltStore format
        run: |
          echo "Converting apps.json to altstore.json..."
          python convert_to_altstore.py

      - name: Verify altstore.json was created
        run: |
          if [ ! -f altstore.json ]; then
            echo "Error: altstore.json was not created"
            exit 1
          fi
          echo "altstore.json created successfully"
          ls -lh altstore.json

      - name: Commit and push altstore changes
        run: |
          git config --local user.email "github-actions@github.local"
          git config --local user.name "GitHub Actions"
          git add altstore.json
          git diff --staged --quiet || git commit -m "Update altstore.json [skip ci]"
          git push
